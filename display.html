<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <title>Οθόνη Κλειδώματος</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: url('https://c4.wallpaperflare.com/wallpaper/205/661/279/crete-agios-nikolaos-greece-europe-wallpaper-preview.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto,
        Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      color: #f0f0f5;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      position: relative;
    }

    .lockscreen-container {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 24px;
      padding: 60px 100px;
      backdrop-filter: blur(15px);
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.5),
        inset 0 0 0 1px rgba(255, 255, 255, 0.2);
      text-align: center;
      max-width: 500px;
      width: 90vw;
      user-select: none;
      z-index: 1;
    }

    #time {
      font-weight: 300;
      font-size: 96px;
      letter-spacing: 4px;
      line-height: 1.05;
      margin-bottom: 12px;
      color: #000000dd;
      text-shadow: 0 1px 4px rgba(255, 255, 255, 0.7);
      background: rgba(255 255 255 / 0.6);
      border-radius: 16px;
      padding: 10px 20px;
      display: inline-block;
      user-select: text;
    }

    #date {
      font-weight: 400;
      font-size: 22px;
      letter-spacing: 0.04em;
      color: #202020cc;
      margin-bottom: 40px;
      text-shadow: 0 1px 3px rgba(255, 255, 255, 0.5);
      user-select: text;
    }

    /* Popup μήνυμα */
    #message-popup {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255 255 255 / 0.15);
      padding: 20px 35px;
      border-radius: 24px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.5);
      font-size: 28px;
      color: #f0f0f5;
      cursor: pointer;
      max-width: 80vw;
      text-align: center;
      user-select: text;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
      backdrop-filter: blur(20px);
      z-index: 10;
    }
    #message-popup.visible {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div class="lockscreen-container" role="main" aria-label="Οθόνη Κλειδώματος">
    <div id="time" aria-live="polite">--:--</div>
    <div id="date" aria-live="polite">Φόρτωση ημερομηνίας...</div>
  </div>

  <div id="message-popup" role="alert" aria-live="assertive" tabindex="0"></div>

  <audio id="notify-sound" src="ding.mp3" preload="auto"></audio>

  <script>
    const timeElement = document.getElementById('time');
    const dateElement = document.getElementById('date');
    const messagePopup = document.getElementById('message-popup');
    const sound = document.getElementById('notify-sound');

    let lastMessage = '';
    let fetchAbortController = null;
    let failureCount = 0;
    let fetchIntervalId = null;

    function updateTimeAndDate() {
      const now = new Date();
      timeElement.textContent = now.toLocaleTimeString('el-GR', {hour: '2-digit', minute: '2-digit', hour12: false});
      dateElement.textContent = now.toLocaleDateString('el-GR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      });
    }

    setInterval(updateTimeAndDate, 1000);
    updateTimeAndDate();

    // Close popup on click
    messagePopup.addEventListener('click', () => {
      messagePopup.classList.remove('visible');
    });

    async function fetchMessage() {
      if (fetchAbortController) {
        fetchAbortController.abort();
      }
      fetchAbortController = new AbortController();
      const signal = fetchAbortController.signal;

      try {
        const url = 'https://raw.githubusercontent.com/SkroI/smart-display/main/message.txt?t=' + Date.now();
        const response = await fetch(url, {cache: 'no-store', mode: 'cors', signal});
        if (!response.ok) throw new Error('Απέτυχε η λήψη');

        const text = await response.text();
        const trimmedText = text.trim();

        if (trimmedText && trimmedText !== lastMessage) {
          lastMessage = trimmedText;
          messagePopup.textContent = trimmedText;
          messagePopup.classList.add('visible');

          sound.currentTime = 0;
          sound.play().catch(() => {});
        } else if (!trimmedText) {
          lastMessage = '';
          messagePopup.classList.remove('visible');
        }

        failureCount = 0;
      } catch (e) {
        if (e.name !== 'AbortError') {
          failureCount++;
          console.error('Fetch error:', e);

          if (failureCount >= 3) {
            console.warn('Too many fetch failures, stopping fetch attempts.');
            clearInterval(fetchIntervalId);
          }
        }
      }
    }

    fetchIntervalId = setInterval(fetchMessage, 30000);
    fetchMessage();
  </script>
</body>
</html>
